{% extends 'base_dashboard.html' %}

{% block title %} Tableau de Bord National{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- HEADER & FILTERS -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-extrabold text-ivoiregreen dark:text-[#28d0ff]">Santé de la Population</h1>
      <p class="text-gray-500 dark:text-gray-400">Vue nationale · mise à jour {{ last_update|default:"--/--/----" }}</p>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <select id="periodSelect" class="border rounded-lg px-3 py-2 text-sm dark:bg-white/5 dark:border-white/10">
        <option>2025 (YTD)</option>
        <option>2024</option>
        <option>2023</option>
      </select>
      <select id="presSelect" class="border rounded-lg px-3 py-2 text-sm dark:bg-white/5 dark:border-white/10">
        <option value="ALL">Tous les PRES</option>
        <option value="PRES ABIDJAN">PRES ABIDJAN</option>
        <option value="PRES YAMOUSSOUKRO">PRES YAMOUSSOUKRO</option>
        <option value="PRES SAN PEDRO">PRES SAN PEDRO</option>
        <option value="PRES ODIENNE">PRES ODIENNE</option>
        <option value="PRES MAN">PRES MAN</option>
        <option value="PRES KORHOGO">PRES KORHOGO</option>
        <option value="PRES DALOA">PRES DALOA</option>
        <option value="PRES BOUAKE">PRES BOUAKE</option>
        <option value="PRES BONDOUKOU">PRES BONDOUKOU</option>
        <option value="PRES ABENGOUROU">PRES ABENGOUROU</option>
      </select>
      <select id="regionSelect" class="border rounded-lg px-3 py-2 text-sm dark:bg-white/5 dark:border-white/10">
        <option value="ALL">Toutes les régions</option>
      </select>
    </div>
  </div>

  <!-- KPIs (Nationaux / ou filtrés PRES) -->
  <div id="kpiWrap" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>

  <!-- KPI STRIP 2 : Indicateurs clés nationaux -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 dark:text-gray-400 text-sm">Incidence paludisme</p>
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">125.8/1000</h3>
          <p class="text-red-600 text-xs mt-1"><i class="fas fa-arrow-down"></i> -12% vs 2024</p>
        </div>
        <div class="p-3 rounded-full bg-ivoire-blue/10"><i class="fas fa-bug text-ivoire-blue text-xl"></i></div>
      </div>
    </div>
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 dark:text-gray-400 text-sm">Couverture DTP3</p>
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">82%</h3>
          <p class="text-green-600 text-xs mt-1"><i class="fas fa-arrow-up"></i> +4 pts vs 2024</p>
        </div>
        <div class="p-3 rounded-full bg-ivoire-green/10"><i class="fas fa-syringe text-ivoire-green text-xl"></i></div>
      </div>
    </div>
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 dark:text-gray-400 text-sm">Distance moyenne d’accès</p>
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">7.8 km</h3>
          <p class="text-gray-500 text-xs mt-1">National (tous niveaux)</p>
        </div>
        <div class="p-3 rounded-full bg-ivoire-orange/10"><i class="fas fa-route text-ivoire-orange text-xl"></i></div>
      </div>
    </div>
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 dark:text-gray-400 text-sm">Satisfaction usagers</p>
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">82%</h3>
          <p class="text-green-600 text-xs mt-1"><i class="fas fa-arrow-up"></i> +3 pts vs 2024</p>
        </div>
        <div class="p-3 rounded-full bg-ivoire-purple/10"><i class="fas fa-smile text-ivoire-purple text-xl"></i></div>
      </div>
    </div>
  </div>

  <!-- CHARTS: PRES OVERVIEW -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Couverture vaccinale par PRES</h2>
      <div class="h-80"><canvas id="chartCoverageByPRES"></canvas></div>
    </div>
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Mortalité infantile par PRES</h2>
      <div class="h-80"><canvas id="chartInfantMortalityByPRES"></canvas></div>
    </div>
  </div>

  <!-- CHARTS: FOCUS PRES SÉLECTIONNÉ -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10 lg:col-span-2">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Profil du PRES sélectionné</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Radar des indicateurs clés (vaccination, mortalité inf., satisfaction, accès)</p>
      <div class="h-80"><canvas id="chartPresRadar"></canvas></div>
    </div>
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Population par PRES (répartition)</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Données simulées pour l'exemple</p>
      <div class="h-80"><canvas id="chartPopulationShare"></canvas></div>
    </div>
  </div>

  <!-- CHARTS: Tendance & NCD -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Tendance trimestrielle — principaux indicateurs</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Consultations / hospitalisations / DTP3</p>
      <div class="h-80"><canvas id="chartQuarterlyTrend"></canvas></div>
    </div>
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Maladies chroniques (NCD) par PRES</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Prévalences simulées (HTA, diabète)</p>
      <div class="h-80"><canvas id="chartNCDByPRES"></canvas></div>
    </div>
  </div>

  <!-- TABLE: Mapping Régions → PRES + Districts du PRES sélectionné -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Correspondance Régions ↔︎ PRES</h2>
      <div class="overflow-auto max-h-[420px]">
        <table class="min-w-full text-sm">
          <thead class="sticky top-0 bg-gray-50 dark:bg-white/10">
            <tr>
              <th class="text-left p-2 font-semibold">Région</th>
              <th class="text-left p-2 font-semibold">PRES</th>
            </tr>
          </thead>
          <tbody id="regionPresBody"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Districts du PRES sélectionné</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Indicateurs clés par district (données simulées)</p>
      <div class="overflow-auto max-h-[420px]">
        <table class="min-w-full text-sm">
          <thead class="sticky top-0 bg-gray-50 dark:bg-white/10">
            <tr>
              <th class="text-left p-2 font-semibold">District</th>
              <th class="text-left p-2 font-semibold">Couverture vaccinale</th>
              <th class="text-left p-2 font-semibold">Mort. infantile</th>
              <th class="text-left p-2 font-semibold">Satisfaction</th>
              <th class="text-left p-2 font-semibold">Accès moyen (km)</th>
            </tr>
          </thead>
          <tbody id="districtBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== DATA (Mapping & Simulations) =====================
const REGION_TO_PRES = {
  "N'ZI":"PRES YAMOUSSOUKRO","MARAHOUE":"PRES YAMOUSSOUKRO","LÔH-DJIBOUA":"PRES YAMOUSSOUKRO","GOH":"PRES YAMOUSSOUKRO","BELIER":"PRES YAMOUSSOUKRO",
  "SAN PEDRO":"PRES SAN PEDRO","NAWA":"PRES SAN PEDRO","GBOKLE":"PRES SAN PEDRO",
  "KABADOUGOU":"PRES ODIENNE","FOLON":"PRES ODIENNE","BAGOUE":"PRES ODIENNE",
  "TONKPI":"PRES MAN","GUEMON":"PRES MAN","CAVALLY":"PRES MAN","BAFING":"PRES MAN",
  "TCHOLOGO":"PRES KORHOGO","PORO":"PRES KORHOGO",
  "WORODOUGOU":"PRES DALOA","HAUT-SASSANDRA":"PRES DALOA",
  "HAMBOL":"PRES BOUAKE","GBEKE":"PRES BOUAKE","BERE":"PRES BOUAKE",
  "GONTOUGO":"PRES BONDOUKOU","BOUKANI":"PRES BONDOUKOU",
  "SUD COMOE":"PRES ABIDJAN","ME":"PRES ABIDJAN","GRANDS-PONTS":"PRES ABIDJAN","AGNEBY-TIASSA":"PRES ABIDJAN","ABIDJAN 2":"PRES ABIDJAN","ABIDJAN 1":"PRES ABIDJAN",
  "MORONOU":"PRES ABENGOUROU","INDENIE-DJUABLIN":"PRES ABENGOUROU","IFFOU":"PRES ABENGOUROU"
};

const PRES_LIST = ['PRES ABIDJAN','PRES YAMOUSSOUKRO','PRES SAN PEDRO','PRES ODIENNE','PRES MAN','PRES KORHOGO','PRES DALOA','PRES BOUAKE','PRES BONDOUKOU','PRES ABENGOUROU'];

// Données simulées par PRES
const DATA_PRES = PRES_LIST.reduce((acc, pres, i)=>{
  acc[pres] = {
    lifeExp: 57 + (i%5)*0.6,            // espérance de vie
    vacc: 65 + (i*3 % 20),              // couverture vaccinale
    infantMortality: 50 + (i*4 % 25),   // pour 1000
    satisfaction: 70 + (i*2 % 20),      // %
    accessKm: 6 + (i*1.2 % 8),          // km moyen d'accès
    popShare: 5 + (i*2 % 12)            // % part population
  };
  return acc;
}, {});

// Districts simulés par PRES
function sampleDistricts(pres){
  const n = 4 + Math.floor(Math.random()*3);
  const rows = [];
  for(let k=1;k<=n;k++){
    rows.push({
      name: pres.split(' ')[1] + ' - District ' + k,
      vacc: Math.round(60 + Math.random()*30),
      mort: Math.round(40 + Math.random()*35),
      sat: Math.round(65 + Math.random()*25),
      access: (5 + Math.random()*10).toFixed(1)
    });
  }
  return rows;
}

// ===================== UI INIT (Regions for selected PRES) =====================
const regionSelect = document.getElementById('regionSelect');
const presSelect = document.getElementById('presSelect');

function populateRegionsFor(pres){
  regionSelect.innerHTML = '<option value="ALL">Toutes les régions</option>';
  Object.entries(REGION_TO_PRES)
    .filter(([r,p]) => pres==='ALL' ? true : p===pres)
    .forEach(([r])=>{
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r; regionSelect.appendChild(opt);
    });
}
populateRegionsFor('ALL');

// ===================== KPI RENDER =====================
// Couleurs fixes (évite les classes dynamiques Tailwind)
const KPI_COLORS = {
  blue:  {bg:'rgba(0,153,204,.10)', text:'#0099CC', hex:'#0099CC'},
  green: {bg:'rgba(51,204,102,.10)', text:'#33CC66', hex:'#33CC66'},
  orange:{bg:'rgba(255,102,0,.10)', text:'#FF6600', hex:'#FF6600'},
  purple:{bg:'rgba(153,102,204,.10)', text:'#9966CC', hex:'#9966CC'}
};

const KPI_CFG = [
  { key:'lifeExp', label:"Espérance de vie", fmt:(v)=>v.toFixed(1)+' ans', color:'blue',  icon:'fa-heartbeat' },
  { key:'vacc', label:"Couverture vaccinale", fmt:(v)=>v+'%', color:'green', icon:'fa-syringe' },
  { key:'infantMortality', label:"Mortalité infantile", fmt:(v)=>v+'‰', color:'orange', icon:'fa-baby' },
  { key:'satisfaction', label:"Satisfaction usagers", fmt:(v)=>v+'%', color:'purple', icon:'fa-smile' }
];

function computeAggregated(pres){
  if(pres==='ALL'){
    const agg = {lifeExp:0,vacc:0,infantMortality:0,satisfaction:0};
    PRES_LIST.forEach(p=>{ const d=DATA_PRES[p]; Object.keys(agg).forEach(k=> agg[k]+=d[k]); });
    Object.keys(agg).forEach(k=> agg[k] = +(agg[k]/PRES_LIST.length).toFixed(k==='lifeExp'?1:0));
    return agg;
  }
  const d = DATA_PRES[pres];
  return {
    lifeExp: +d.lifeExp.toFixed(1),
    vacc: Math.round(d.vacc),
    infantMortality: Math.round(d.infantMortality),
    satisfaction: Math.round(d.satisfaction)
  };
}

function renderKPIs(pres){
  const kpiWrap = document.getElementById('kpiWrap');
  const data = computeAggregated(pres);
  kpiWrap.innerHTML = '';
  KPI_CFG.forEach(k => {
    const v = data[k.key];
    const c = KPI_COLORS[k.color];
    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-white/5 rounded-xl shadow-md p-6 border border-gray-100 dark:border-white/10';
    card.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 dark:text-gray-400 text-sm">${k.label}</p>
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">${k.fmt(v)}</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${pres==='ALL'?'Moyenne nationale':'PRES sélectionné'}</p>
        </div>
        <div class="p-3 rounded-full" style="background:${c.bg}"><i class="fas ${k.icon}" style="color:${c.text}"></i></div>
      </div>
      <span class="block mt-4 h-1 rounded" style="background:${c.hex}"></span>`;
    kpiWrap.appendChild(card);
  });
}
renderKPIs('ALL');

// ===================== TABLES (Regions & Districts) =====================
function renderRegionTable(){
  const body = document.getElementById('regionPresBody');
  body.innerHTML = '';
  Object.entries(REGION_TO_PRES)
    .sort(([a],[b])=>a.localeCompare(b))
    .forEach(([region,pres])=>{
      const tr = document.createElement('tr');
      tr.className = 'border-b border-gray-100 dark:border-white/10';
      tr.innerHTML = `<td class="p-2">${region}</td><td class="p-2">${pres}</td>`;
      body.appendChild(tr);
    });
}
renderRegionTable();

function renderDistricts(pres){
  const body = document.getElementById('districtBody');
  body.innerHTML = '';
  if(pres==='ALL'){ body.innerHTML = '<tr><td colspan="5" class="p-2 text-gray-500 dark:text-gray-400">Sélectionnez un PRES pour voir le détail des districts.</td></tr>'; return; }
  const rows = sampleDistricts(pres);
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className = 'border-b border-gray-100 dark:border-white/10';
    tr.innerHTML = `<td class="p-2">${r.name}</td>
                    <td class="p-2">${r.vacc}%</td>
                    <td class="p-2">${r.mort}‰</td>
                    <td class="p-2">${r.sat}%</td>
                    <td class="p-2">${r.access}</td>`;
    body.appendChild(tr);
  });
}
renderDistricts('ALL');

// ===================== CHARTS (Chart.js) =====================
let coverageByPRES, infantMortalityByPRES, presRadar, populationShare, quarterlyTrend, ncdByPres;

function baseColors(){
  const dark = document.documentElement.classList.contains('dark');
  return {
    grid: dark ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.08)',
    text: dark ? 'rgba(255,255,255,0.9)' : '#111827'
  };
}

function buildCoverageByPRES(){
  const ctx = document.getElementById('chartCoverageByPRES').getContext('2d');
  const labels = PRES_LIST;
  const data = labels.map(l=> DATA_PRES[l].vacc);
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Couverture (%)', data, backgroundColor: 'rgba(51,204,102,.7)', borderRadius: 8 }]},
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100, grid:{ color: baseColors().grid } }, x:{ grid:{ display:false } } }, plugins:{ legend:{ labels:{ color: baseColors().text } } } }
  });
}

function buildInfantMortalityByPRES(){
  const ctx = document.getElementById('chartInfantMortalityByPRES').getContext('2d');
  const labels = PRES_LIST;
  const data = labels.map(l=> DATA_PRES[l].infantMortality);
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Pour 1000 naissances vivantes', data, backgroundColor: 'rgba(255,102,0,.7)', borderRadius: 8 }]},
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{ color: baseColors().grid } }, x:{ grid:{ display:false } } }, plugins:{ legend:{ labels:{ color: baseColors().text } } } }
  });
}

function buildPresRadar(pres){
  const ctx = document.getElementById('chartPresRadar').getContext('2d');
  const d = pres==='ALL' ? computeAggregated('ALL') : DATA_PRES[pres];
  return new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['Vaccination','Mortalité inf. (inv)','Satisfaction','Accès (inv)'],
      datasets: [{
        label: pres,
        data: [d.vacc, 120-d.infantMortality, d.satisfaction, 20-d.accessKm],
        borderColor: '#0099CC',
        backgroundColor: '#0099CC22',
        pointBackgroundColor: '#0099CC'
      }]
    },
    options: { responsive:true, maintainAspectRatio:false, scales:{ r:{ angleLines:{ color: baseColors().grid }, grid:{ color: baseColors().grid }, pointLabels:{ color: baseColors().text } } }, plugins:{ legend:{ labels:{ color: baseColors().text } } } }
  });
}

function buildPopulationShare(){
  const ctx = document.getElementById('chartPopulationShare').getContext('2d');
  const labels = PRES_LIST;
  const data = labels.map(l=> DATA_PRES[l].popShare);
  return new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: ['#0099CC','#33CC66','#FF6600','#9966CC','#10b981','#f59e0b','#3b82f6','#ef4444','#8b5cf6','#14b8a6'] }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color: baseColors().text } } } }
  });
}

function buildQuarterlyTrend(){
  const ctx = document.getElementById('chartQuarterlyTrend').getContext('2d');
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['T1','T2','T3','T4'],
      datasets: [
        { label:'Consultations (M)', data:[3.8,4.1,4.3,4.5], borderColor:'#3b82f6', backgroundColor:'#3b82f622', fill:true, tension:.35 },
        { label:'Hospitalisations (k)', data:[112,118,121,125], borderColor:'#ef4444', backgroundColor:'#ef444422', fill:true, tension:.35 },
        { label:'DTP3 (%)', data:[78,80,81,82], borderColor:'#10b981', backgroundColor:'#10b98122', fill:true, tension:.35 }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:false, grid:{ color: baseColors().grid } }, x:{ grid:{ display:false } } }, plugins:{ legend:{ labels:{ color: baseColors().text } } } }
  });
}

function buildNCDByPRES(){
  const ctx = document.getElementById('chartNCDByPRES').getContext('2d');
  const labels = PRES_LIST;
  const hta = labels.map((_,i)=> 18 + (i*1.5 % 6));   // HTA simulée (%)
  const diab = labels.map((_,i)=> 6 + (i*1.1 % 4));   // Diabète simulé (%)
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label:'HTA (%)', data: hta, backgroundColor:'rgba(99,102,241,.75)', borderRadius:8 },
      { label:'Diabète (%)', data: diab, backgroundColor:'rgba(16,185,129,.75)', borderRadius:8 }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, grid:{ color: baseColors().grid } }, x:{ grid:{ display:false } } }, plugins:{ legend:{ labels:{ color: baseColors().text } } } }
  });
}

coverageByPRES       = buildCoverageByPRES();
infantMortalityByPRES= buildInfantMortalityByPRES();
presRadar            = buildPresRadar('ALL');
populationShare      = buildPopulationShare();
quarterlyTrend       = buildQuarterlyTrend();
ncdByPres            = buildNCDByPRES();

// ===================== EVENTS =====================
presSelect.addEventListener('change', ()=>{
  const pres = presSelect.value;
  populateRegionsFor(pres);
  renderKPIs(pres);
  if(presRadar){ presRadar.destroy(); }
  presRadar = buildPresRadar(pres);
  renderDistricts(pres);
});

// Recolor charts on theme change
window.addEventListener('themechange', ()=>{
  [coverageByPRES, infantMortalityByPRES, presRadar, populationShare, quarterlyTrend, ncdByPres].forEach(ch=> ch?.destroy());
  coverageByPRES       = buildCoverageByPRES();
  infantMortalityByPRES= buildInfantMortalityByPRES();
  presRadar            = buildPresRadar(presSelect.value||'ALL');
  populationShare      = buildPopulationShare();
  quarterlyTrend       = buildQuarterlyTrend();
  ncdByPres            = buildNCDByPRES();
});
</script>
{% endblock %}